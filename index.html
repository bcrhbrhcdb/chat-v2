<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat App</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="chat-container">
    <div class="sign-in-container">
      <input type="email" placeholder="Email" id="email-input">
      <input type="password" placeholder="Password" id="password-input">
      <button id="sign-in-button">Sign In</button>
      <button id="sign-up-button">Sign Up</button>
    </div>
    <div class="name-input" style="display: none;">
      <input type="text" placeholder="Enter your name..." id="name-input">
      <button id="join-button">Join</button>
    </div>
    <div class="chat-messages" id="chat-messages"></div>
    <div class="chat-input" style="display: none;">
      <input type="text" placeholder="Type your message..." id="message-input">
      <button id="send-button">Send</button>
      <button id="change-name-button">Change Name</button>
      <button id="sign-out-button">Sign Out</button>
    </div>
    <div class="profile-menu" style="display: none;">
      <input type="text" placeholder="Enter new name..." id="new-name-input">
      <button id="save-name-button">Save</button>
    </div>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://unpkg.com/bad-words/lib/badwords.json"></script>
  <script src="script.js"></script>
</head>
<body>
  <script>
    const supabaseUrl = 'https://bnutqttgqvrclfxyuulf.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJudXRxdHRncXZyY2xmeHl1dWxmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MTUzNjc5NzEsImV4cCI6MjAzMDk0Mzk3MX0.8H5iT0NXOLjOgqHZlhn-2rAmwaxCCdx-1b2_e8VM2Hg';
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    const emailInput = document.getElementById('email-input');
    const passwordInput = document.getElementById('password-input');
    const signInButton = document.getElementById('sign-in-button');
    const signUpButton = document.getElementById('sign-up-button');
    const nameInput = document.getElementById('name-input');
    const joinButton = document.getElementById('join-button');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const newNameInput = document.getElementById('new-name-input');
    const saveNameButton = document.getElementById('save-name-button');
    const chatMessages = document.getElementById('chat-messages');

    const Filter = require('bad-words');
    const filter = new Filter({ placeHolder: '*' });
    filter.addWords(...badwords);

    signInButton.addEventListener('click', async () => {
      const email = emailInput.value;
      const password = passwordInput.value;
      const { user, error } = await supabase.auth.signIn({ email, password });
      // Handle the response and update the UI accordingly
    });

    signUpButton.addEventListener('click', async () => {
      const email = emailInput.value;
      const password = passwordInput.value;
      const { user, error } = await supabase.auth.signUp({ email, password });
      // Handle the response and update the UI accordingly
    });

    joinButton.addEventListener('click', async () => {
      const username = nameInput.value;
      if (filter.isProfane(username)) {
        alert('Please choose a different username.');
        return;
      }
      const { user, error } = await supabase.auth.user();
      await supabase.from('users').insert({ id: user.id, username });
      // Update the UI and proceed to the chat
    });

    saveNameButton.addEventListener('click', async () => {
      const newUsername = newNameInput.value;
      if (filter.isProfane(newUsername)) {
        alert('Please choose a different username.');
        return;
      }
      const { user, error } = await supabase.auth.user();
      await supabase.from('users').update({ username: newUsername }).match({ id: user.id });
      // Update the UI with the new username
    });

    sendButton.addEventListener('click', async () => {
      const message = messageInput.value.trim();
      if (message === '') return;
      const filteredMessage = filter.clean(message);
      const { user, error } = await supabase.auth.user();
      const { username } = (await supabase.from('users').select('username').match({ id: user.id })).data[0];
      await supabase.from('messages').insert({ user_id: user.id, username, message: filteredMessage });
      messageInput.value = '';
      // Fetch and display the updated messages
    });

    // Fetch and display messages on page load
    const { data: messages, error: messagesError } = await supabase
      .from('messages')
      .select('*')
      .order('created_at', { ascending: true });
    messages.forEach(message => {
      const messageElement = document.createElement('div');
      messageElement.textContent = `${message.username}: ${message.message}`;
      chatMessages.appendChild(messageElement);
    });

    // Listen for real-time updates
    supabase
      .from('messages')
      .on('INSERT', payload => {
        const messageElement = document.createElement('div');
        messageElement.textContent = `${payload.new.username}: ${payload.new.message}`;
        chatMessages.appendChild(messageElement);
      })
      .subscribe();
  </script>
</body>
</html>